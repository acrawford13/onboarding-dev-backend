/* eslint-disable global-require */
const path = require('path');
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors')
const { Map, List, fromJS } = require('immutable');

const { errorHandling, originValidation } = require('./src/middlewares');

const PORT = process.env.PORT || 3030;
const HOST = process.env.HOST || 'localhost';

const app = express();

app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(cors({ origin: true, methods: ['GET', 'PUT', 'POST', 'DELETE'] }))

let data = fromJS(
  {
    "status": "not_opened",
    "codelist":{
      "transport_methods":[
         {
            "label":"Flight",
            "value":"flight"
         },
         {
            "label":"Train",
            "value":"train"
         },
         {
            "label":"Bus",
            "value":"bus"
         }
      ],
      "bed_types":[
         {
            "label":"Queen bed",
            "value":"queen_bed",
            "icon": "M983.040 896.67c0 24.064-19.579 43.622-43.643 43.622h-854.815c-24.044 0-43.622-19.558-43.622-43.622v-171.868h942.080v171.868zM94.822 382.888h834.376l50.135 300.954h-934.666l50.156-300.954zM170.066 40.954h683.848c24.064 0 43.643 19.579 43.643 43.643v86.364h-48.333l-3.482-25.088c-1.393-10.117-10.056-17.654-20.275-17.654h-243.077c-5.509 0-10.793 2.212-14.643 6.144s-5.939 9.257-5.837 14.766l0.553 26.726h-90.173l0.553-26.726c0.123-5.509-2.007-10.834-5.837-14.766-3.871-3.932-9.155-6.144-14.643-6.144h-243.098c-10.22 0-18.883 7.537-20.275 17.654l-3.482 25.088h-59.064v-86.364c0-24.064 19.558-43.643 43.622-43.643zM603.279 169.179h204.349l12.104 87.265h-214.63l-1.823-87.265zM214.958 256.444l12.145-87.265h204.329l-1.802 87.265h-214.671zM123.31 211.921h56.504l-8.663 62.198c-0.819 5.857 0.942 11.796 4.833 16.261s9.544 7.025 15.462 7.025h258.232c11.141 0 20.234-8.909 20.48-20.050l1.27-60.539h91.873l1.249 60.539c0.246 11.141 9.339 20.050 20.48 20.050h258.232c5.919 0 11.551-2.56 15.442-7.025s5.652-10.404 4.833-16.261l-8.622-62.198h45.773l21.668 130.007h-820.716l21.668-130.007zM1023.631 702.54c-0.041-0.532 0.184-1.044 0.082-1.577l-85.197-511.222v-105.144c0-46.653-37.949-84.603-84.603-84.603h-683.848c-46.633 0-84.582 37.949-84.582 84.603v105.144l-85.197 511.222c-0.102 0.532 0.123 1.044 0.082 1.577-0.061 0.614-0.369 1.167-0.369 1.782v192.348c0 46.633 37.949 84.582 84.582 84.582h43.643v22.262c0 11.325 9.155 20.48 20.48 20.48 11.305 0 20.48-9.155 20.48-20.48v-22.262h685.629v22.262c0 11.325 9.175 20.48 20.48 20.48 11.325 0 20.48-9.155 20.48-20.48v-22.262h43.622c46.633 0 84.603-37.949 84.603-84.582v-192.348c0-0.614-0.307-1.167-0.369-1.782z",
         },
         {
            "label":"King bed",
            "value":"king_bed",
            "icon": "M983.040 896.67c0 24.064-19.579 43.622-43.643 43.622h-854.815c-24.044 0-43.622-19.558-43.622-43.622v-171.868h942.080v171.868zM94.822 382.888h834.376l50.135 300.954h-934.666l50.156-300.954zM170.066 40.954h683.848c24.064 0 43.643 19.579 43.643 43.643v86.364h-48.333l-3.482-25.088c-1.393-10.117-10.056-17.654-20.275-17.654h-243.077c-5.509 0-10.793 2.212-14.643 6.144s-5.939 9.257-5.837 14.766l0.553 26.726h-90.173l0.553-26.726c0.123-5.509-2.007-10.834-5.837-14.766-3.871-3.932-9.155-6.144-14.643-6.144h-243.098c-10.22 0-18.883 7.537-20.275 17.654l-3.482 25.088h-59.064v-86.364c0-24.064 19.558-43.643 43.622-43.643zM603.279 169.179h204.349l12.104 87.265h-214.63l-1.823-87.265zM214.958 256.444l12.145-87.265h204.329l-1.802 87.265h-214.671zM123.31 211.921h56.504l-8.663 62.198c-0.819 5.857 0.942 11.796 4.833 16.261s9.544 7.025 15.462 7.025h258.232c11.141 0 20.234-8.909 20.48-20.050l1.27-60.539h91.873l1.249 60.539c0.246 11.141 9.339 20.050 20.48 20.050h258.232c5.919 0 11.551-2.56 15.442-7.025s5.652-10.404 4.833-16.261l-8.622-62.198h45.773l21.668 130.007h-820.716l21.668-130.007zM1023.631 702.54c-0.041-0.532 0.184-1.044 0.082-1.577l-85.197-511.222v-105.144c0-46.653-37.949-84.603-84.603-84.603h-683.848c-46.633 0-84.582 37.949-84.582 84.603v105.144l-85.197 511.222c-0.102 0.532 0.123 1.044 0.082 1.577-0.061 0.614-0.369 1.167-0.369 1.782v192.348c0 46.633 37.949 84.582 84.582 84.582h43.643v22.262c0 11.325 9.155 20.48 20.48 20.48 11.305 0 20.48-9.155 20.48-20.48v-22.262h685.629v22.262c0 11.325 9.175 20.48 20.48 20.48 11.325 0 20.48-9.155 20.48-20.48v-22.262h43.622c46.633 0 84.603-37.949 84.603-84.582v-192.348c0-0.614-0.307-1.167-0.369-1.782z",
         },
         {
            "label":"Single bed",
            "value":"single_bed",
            "icon":"M983.040 896.67c0 24.064-19.579 43.622-43.622 43.622h-854.835c-24.044 0-43.622-19.558-43.622-43.622v-171.868h942.080v171.868zM149.217 382.888h725.565l100.332 300.954h-926.228l100.332-300.954zM255.549 40.954h512.901c24.064 0 43.622 19.579 43.622 43.643v86.364h-78.725l-9.585-28.733c-2.785-8.376-10.609-14.008-19.436-14.008h-384.655c-8.827 0-16.65 5.632-19.436 14.008l-9.585 28.733h-78.725v-86.364c0-24.064 19.558-43.643 43.622-43.643zM334.438 169.179h355.123l29.102 87.265h-413.327l29.102-87.265zM206.193 211.921h70.82l-19.517 58.532c-2.068 6.246-1.024 13.107 2.826 18.452s10.035 8.499 16.609 8.499h470.139c6.574 0 12.759-3.154 16.609-8.499s4.895-12.206 2.826-18.452l-19.517-58.532h70.82l43.336 130.007h-698.286l43.336-130.007zM1023.898 703.789c-0.061-2.007-0.307-3.994-0.942-5.939l-169.923-509.747v-103.506c0-46.653-37.949-84.603-84.582-84.603h-512.901c-46.633 0-84.582 37.949-84.582 84.603v103.506l-169.923 509.747c-0.635 1.946-0.881 3.932-0.942 5.939 0 0.184-0.102 0.348-0.102 0.532v192.348c0 46.633 37.949 84.582 84.582 84.582h43.643v22.262c0 11.325 9.155 20.48 20.48 20.48 11.305 0 20.48-9.155 20.48-20.48v-22.262h685.629v22.262c0 11.325 9.175 20.48 20.48 20.48 11.325 0 20.48-9.155 20.48-20.48v-22.262h43.643c46.633 0 84.582-37.949 84.582-84.582v-192.348c0-0.184-0.102-0.348-0.102-0.532z"
         },
         {
            "label":"Double bed",
            "value":"double_bed",
            "icon": "M983.040 896.67c0 24.064-19.579 43.622-43.643 43.622h-854.815c-24.044 0-43.622-19.558-43.622-43.622v-171.868h942.080v171.868zM94.822 382.888h834.376l50.135 300.954h-934.666l50.156-300.954zM170.066 40.954h683.848c24.064 0 43.643 19.579 43.643 43.643v86.364h-48.333l-3.482-25.088c-1.393-10.117-10.056-17.654-20.275-17.654h-243.077c-5.509 0-10.793 2.212-14.643 6.144s-5.939 9.257-5.837 14.766l0.553 26.726h-90.173l0.553-26.726c0.123-5.509-2.007-10.834-5.837-14.766-3.871-3.932-9.155-6.144-14.643-6.144h-243.098c-10.22 0-18.883 7.537-20.275 17.654l-3.482 25.088h-59.064v-86.364c0-24.064 19.558-43.643 43.622-43.643zM603.279 169.179h204.349l12.104 87.265h-214.63l-1.823-87.265zM214.958 256.444l12.145-87.265h204.329l-1.802 87.265h-214.671zM123.31 211.921h56.504l-8.663 62.198c-0.819 5.857 0.942 11.796 4.833 16.261s9.544 7.025 15.462 7.025h258.232c11.141 0 20.234-8.909 20.48-20.050l1.27-60.539h91.873l1.249 60.539c0.246 11.141 9.339 20.050 20.48 20.050h258.232c5.919 0 11.551-2.56 15.442-7.025s5.652-10.404 4.833-16.261l-8.622-62.198h45.773l21.668 130.007h-820.716l21.668-130.007zM1023.631 702.54c-0.041-0.532 0.184-1.044 0.082-1.577l-85.197-511.222v-105.144c0-46.653-37.949-84.603-84.603-84.603h-683.848c-46.633 0-84.582 37.949-84.582 84.603v105.144l-85.197 511.222c-0.102 0.532 0.123 1.044 0.082 1.577-0.061 0.614-0.369 1.167-0.369 1.782v192.348c0 46.633 37.949 84.582 84.582 84.582h43.643v22.262c0 11.325 9.155 20.48 20.48 20.48 11.305 0 20.48-9.155 20.48-20.48v-22.262h685.629v22.262c0 11.325 9.175 20.48 20.48 20.48 11.325 0 20.48-9.155 20.48-20.48v-22.262h43.622c46.633 0 84.603-37.949 84.603-84.582v-192.348c0-0.614-0.307-1.167-0.369-1.782z",
         },
         {
            "label":"Single sofa bed",
            "value":"single_sofa_bed",
            "icon": "M254.661 747.409v-65.004c0-73.871-46.203-140.308-106.209-162.345 6.574-88.801 80.753-159.109 171.213-159.109h19.333c60.027 0 116.49 31.969 147.354 83.476l47.288 78.807c19.087 31.724 53.903 51.425 90.89 51.425h250.778c59.392 0 107.725 48.333 107.725 107.745v65.004h-728.371zM254.661 832.893v-44.524h728.371v44.524h-728.371zM983.032 961.118h-748.851c-59.412 0-107.745-48.333-107.745-107.745v-106.844c0-29.983-17.879-56.73-45.507-68.178-24.269-10.097-39.977-33.669-39.977-60.047 0-35.84 29.164-65.004 65.004-65.004 50.872 0 107.745 55.214 107.745 129.106v191.447h769.331v87.265zM875.307 533.701h-250.778c-22.692 0-44.073-12.083-55.788-31.56l-47.268-78.787c-38.195-63.754-108.114-103.363-182.477-103.363h-19.333c-110.469 0-201.482 84.644-211.784 192.471-0.635-0.020-1.27-0.123-1.925-0.123-58.429 0-105.964 47.534-105.964 105.964 0 42.988 25.6 81.408 65.249 97.894 12.308 5.079 20.234 16.978 20.234 30.331v106.844c0 82.002 66.724 148.705 148.705 148.705h22.262v22.262h40.96v-22.262h429.199v22.262h40.96v-22.262h256.43v-319.672c0-81.981-66.683-148.705-148.685-148.705z"
         },
         {
            "label":"Double sofa bed",
            "value":"double_sofa_bed",
            "icon": "M983.040 831.891c0 35.84-29.164 65.004-65.004 65.004h-812.073c-35.84 0-65.004-29.164-65.004-65.004v-170.967c0-24.044 19.579-43.622 43.643-43.622s43.622 19.579 43.622 43.622v42.742c0 34.857 28.365 63.222 63.222 63.222h641.106c34.857 0 63.222-28.365 63.222-63.222v-42.742c0-24.044 19.558-43.622 43.622-43.622s43.643 19.579 43.643 43.622v170.967zM126.444 575.461c0-82.985 67.502-150.508 150.467-150.508h193.229v300.974h-278.692c-12.288 0-22.262-9.994-22.262-22.262v-42.742c0-31.334-17.347-58.45-42.742-73.073v-12.39zM897.556 575.461v12.39c-25.395 14.623-42.742 41.738-42.742 73.073v42.742c0 12.268-9.974 22.262-22.262 22.262h-321.454v-300.974h235.991c82.964 0 150.467 67.523 150.467 150.508zM939.397 576.342c-0.307 0-0.573 0.082-0.881 0.082v-0.963c0-105.574-85.873-191.468-191.427-191.468h-470.18c-105.554 0-191.427 85.893-191.427 191.468v0.963c-0.307 0-0.573-0.082-0.881-0.082-46.633 0-84.603 37.949-84.603 84.582v170.967c0 51.425 36.844 94.31 85.484 103.895v67.072c0 11.305 9.155 20.48 20.48 20.48s20.48-9.175 20.48-20.48v-65.004h771.113v65.004c0 11.305 9.155 20.48 20.48 20.48s20.48-9.175 20.48-20.48v-67.072c48.64-9.585 85.484-52.47 85.484-103.895v-170.967c0-46.633-37.97-84.582-84.603-84.582z",
         },
         {
            "label":"Single air bed",
            "value":"single_air_bed",
            "icon":"M983.040 896.67c0 24.064-19.579 43.622-43.622 43.622h-854.835c-24.044 0-43.622-19.558-43.622-43.622v-171.868h942.080v171.868zM149.217 382.888h725.565l100.332 300.954h-926.228l100.332-300.954zM255.549 40.954h512.901c24.064 0 43.622 19.579 43.622 43.643v86.364h-78.725l-9.585-28.733c-2.785-8.376-10.609-14.008-19.436-14.008h-384.655c-8.827 0-16.65 5.632-19.436 14.008l-9.585 28.733h-78.725v-86.364c0-24.064 19.558-43.643 43.622-43.643zM334.438 169.179h355.123l29.102 87.265h-413.327l29.102-87.265zM206.193 211.921h70.82l-19.517 58.532c-2.068 6.246-1.024 13.107 2.826 18.452s10.035 8.499 16.609 8.499h470.139c6.574 0 12.759-3.154 16.609-8.499s4.895-12.206 2.826-18.452l-19.517-58.532h70.82l43.336 130.007h-698.286l43.336-130.007zM1023.898 703.789c-0.061-2.007-0.307-3.994-0.942-5.939l-169.923-509.747v-103.506c0-46.653-37.949-84.603-84.582-84.603h-512.901c-46.633 0-84.582 37.949-84.582 84.603v103.506l-169.923 509.747c-0.635 1.946-0.881 3.932-0.942 5.939 0 0.184-0.102 0.348-0.102 0.532v192.348c0 46.633 37.949 84.582 84.582 84.582h43.643v22.262c0 11.325 9.155 20.48 20.48 20.48 11.305 0 20.48-9.155 20.48-20.48v-22.262h685.629v22.262c0 11.325 9.175 20.48 20.48 20.48 11.325 0 20.48-9.155 20.48-20.48v-22.262h43.643c46.633 0 84.582-37.949 84.582-84.582v-192.348c0-0.184-0.102-0.348-0.102-0.532z"
         },
         {
            "label":"Double air bed",
            "value":"double_air_bed",
            "icon": "M983.040 896.67c0 24.064-19.579 43.622-43.643 43.622h-854.815c-24.044 0-43.622-19.558-43.622-43.622v-171.868h942.080v171.868zM94.822 382.888h834.376l50.135 300.954h-934.666l50.156-300.954zM170.066 40.954h683.848c24.064 0 43.643 19.579 43.643 43.643v86.364h-48.333l-3.482-25.088c-1.393-10.117-10.056-17.654-20.275-17.654h-243.077c-5.509 0-10.793 2.212-14.643 6.144s-5.939 9.257-5.837 14.766l0.553 26.726h-90.173l0.553-26.726c0.123-5.509-2.007-10.834-5.837-14.766-3.871-3.932-9.155-6.144-14.643-6.144h-243.098c-10.22 0-18.883 7.537-20.275 17.654l-3.482 25.088h-59.064v-86.364c0-24.064 19.558-43.643 43.622-43.643zM603.279 169.179h204.349l12.104 87.265h-214.63l-1.823-87.265zM214.958 256.444l12.145-87.265h204.329l-1.802 87.265h-214.671zM123.31 211.921h56.504l-8.663 62.198c-0.819 5.857 0.942 11.796 4.833 16.261s9.544 7.025 15.462 7.025h258.232c11.141 0 20.234-8.909 20.48-20.050l1.27-60.539h91.873l1.249 60.539c0.246 11.141 9.339 20.050 20.48 20.050h258.232c5.919 0 11.551-2.56 15.442-7.025s5.652-10.404 4.833-16.261l-8.622-62.198h45.773l21.668 130.007h-820.716l21.668-130.007zM1023.631 702.54c-0.041-0.532 0.184-1.044 0.082-1.577l-85.197-511.222v-105.144c0-46.653-37.949-84.603-84.603-84.603h-683.848c-46.633 0-84.582 37.949-84.582 84.603v105.144l-85.197 511.222c-0.102 0.532 0.123 1.044 0.082 1.577-0.061 0.614-0.369 1.167-0.369 1.782v192.348c0 46.633 37.949 84.582 84.582 84.582h43.643v22.262c0 11.325 9.155 20.48 20.48 20.48 11.305 0 20.48-9.155 20.48-20.48v-22.262h685.629v22.262c0 11.325 9.175 20.48 20.48 20.48 11.325 0 20.48-9.155 20.48-20.48v-22.262h43.622c46.633 0 84.603-37.949 84.603-84.582v-192.348c0-0.614-0.307-1.167-0.369-1.782z",
         }
      ],
      "bed_locations":[
         {
            "value":"bedroom 1",
            "label":"Quarto 1"
         },
         {
            "value":"bedroom 2",
            "label":"Quarto 2"
         },
         {
            "value":"bedroom 3",
            "label":"Quarto 3"
         },
         {
            "value":"common spaces",
            "label":"espaços comum"
         }
      ]
   },
   "data":{
      "city": "London",
      "guest_name": "Stallone",
      "additional_info":"Some thing here",
      "arrival_vehicle_number":"XX666",
      "arrival_vehicle_type":"boat",
      "arriving_time":"14:30",
      "arriving_time_in_property":"15:30",
      "place_of_arrival":"Heathrow Airport",
      "booked_person_id_photo":"url to image",
      "check_in_date":"10/10/2018",
      "check_in_time":"11:00",
      "check_out_date":"12/10/2018",
      "check_out_time":"15:30",
      "guest_email":"stallone@test.com",
      "guest_phone_number":"55540044453",
      "guests_count":"1",
      "keys_pickup_person_id":"url to image",
      "keys_pickup_person_name":"Stallone",
      "same_person_who_booked":true,
      "beds":[
         {
            "name":"single_bed",
            "location":"bedroom 1",
            "id":10,
            "checked":true
         },
         {
            "name":"single_bed",
            "location":"bedroom 1",
            "id":11,
            "checked":true
         },
         {
            "name":"double_sofa_bed",
            "location":"common spaces",
            "id":12,
            "checked":false
         }
      ],
   },
});

app.get(
  '/api/internal/health_check',
  (req, res) => {
    console.log('>>>> healthCheck');
    res.status(200).json(true);
  }
);


app.get(
  '/:locale/check_in_info/v1/guest_form/:uiid',
  (req, res) => {
    console.log('>>>> Get all for: ', req.params);
    console.log('>>>> current_location: ', data.get('current_location'));
    res.status(200).json(data.toJS());
  }
);

app.put(
  '/:locale/check_in_info/v1/guest_form/:uiid', (req, res) => {
    const { data: field } = req.body;
    const path = ['data'].concat(field.resource.split('.'), field.column).filter(path => path);
    console.log('>>>> Update field', req.body, path);
    data = data.setIn(path, field.value);
    res.status(200).json({ field });
  })

app.use(errorHandling);

app.listen(PORT, HOST, () => {
  console.log(`Server listing on ${HOST}:${PORT}`);
});
